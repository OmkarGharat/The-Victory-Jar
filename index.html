<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Victory Jar</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #f0f0f0;
            --accent-gold: #FFD700;
            --accent-gold-dim: #B8860B;
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --btn-primary: #FFD700;
            --btn-primary-hover: #FFC107;
            --btn-text: #1a1a1a;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            max-width: 600px;
        }

        h1 {
            color: var(--accent-gold);
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
        }

        .subtitle {
            color: #aaa;
            font-size: 1rem;
            line-height: 1.5;
        }

        /* Main Container */
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            max-width: 500px;
        }

        /* Canvas Wrapper */
        .canvas-wrapper {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            background: #111;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            padding: 20px 0;
        }

        canvas {
            max-width: 100%;
            height: auto;
            cursor: pointer; /* Click to add marble */
        }

        /* Stats Panel */
        .stats-panel {
            display: flex;
            justify-content: space-between;
            width: 100%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 15px 25px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-gold);
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Motivational Message */
        .message-box {
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-style: italic;
            color: #ccc;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            width: 100%;
            border-radius: 8px;
            padding: 10px;
            transition: all 0.5s ease;
        }

        /* Controls */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
        }

        .controls .full-width {
            grid-column: span 2;
        }

        button {
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background-color: var(--btn-primary);
            color: var(--btn-text);
        }

        .btn-primary:hover {
            background-color: var(--btn-primary-hover);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--glass-border);
            color: #aaa;
        }

        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .btn-danger {
            background-color: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background-color: rgba(239, 68, 68, 0.2);
        }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border-left: 4px solid var(--accent-gold);
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }

        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }

        /* Mobile Adjustments */
        @media (max-width: 400px) {
            h1 { font-size: 2rem; }
            .stat-value { font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <header>
        <h1>The Victory Jar</h1>
        <p class="subtitle">Every day you choose her, your health, and yourself over addiction, you fill this jar. This is your physical proof of strength.</p>
    </header>

    <main class="container">
        
        <div class="stats-panel">
            <div class="stat-item">
                <span class="stat-value" id="dayCount">0</span>
                <span class="stat-label">Days of Victory</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="percentFull">0%</span>
                <span class="stat-label">Progress</span>
            </div>
        </div>

        <div class="message-box" id="motivationText">
            Start your journey today. Click below to add your first marble.
        </div>

        <div class="canvas-wrapper">
            <canvas id="jarCanvas" width="400" height="500"></canvas>
        </div>

        <div class="controls">
            <button class="btn-primary full-width" id="addBtn" onclick="addMarble()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>
                Add Victory Marble
            </button>
            <button class="btn-secondary" onclick="downloadImage()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                Download
            </button>
            <button class="btn-danger" onclick="resetJar()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                Reset
            </button>
        </div>

    </main>

    <div id="toast">Image Saved!</div>

    <script>
        /**
         * Configuration & State
         */
        const canvas = document.getElementById('jarCanvas');
        const ctx = canvas.getContext('2d');
        
        // Jar Configuration
        const JAR_WIDTH = 240;
        const JAR_HEIGHT = 320;
        const JAR_X = (canvas.width - JAR_WIDTH) / 2;
        const JAR_Y = 100;
        const MARBLE_RADIUS = 12;
        const MARBLE_COUNT_GOAL = 150; // When jar is "full"

        let marbles = [];
        let isAnimating = false;

        // Physics Constants
        const GRAVITY = 0.4;
        const FRICTION = 0.8; // Energy loss on bounce
        const BOUNCE_DAMPING = 0.6;

        /**
         * Motivational Messages
         */
        const messages = [
            { threshold: 1, text: "The first step is the hardest. You are doing it." },
            { threshold: 3, text: "Three days of clarity. Keep looking forward." },
            { threshold: 7, text: "One week! The fog is lifting." },
            { threshold: 14, text: "Two weeks. You are building a new habit of strength." },
            { threshold: 30, text: "A whole month. You are rewriting your story." },
            { threshold: 60, text: "Two months. Look at how much you've overcome." },
            { threshold: 90, text: "90 Days. You are becoming the man you want to be." },
            { threshold: 100, text: "Triple digits. Unstoppable." },
            { threshold: 150, text: "The jar is full. It's time for 'The New Us'. Celebrate!" }
        ];

        /**
         * Initialization
         */
        window.onload = function() {
            loadProgress();
            updateStats();
            animate();
        };

        function loadProgress() {
            const savedCount = localStorage.getItem('victoryJarCount');
            if (savedCount) {
                const count = parseInt(savedCount);
                // Pre-fill marbles at the bottom so they don't all drop on load
                // We spawn them randomly within the jar area
                for(let i=0; i<count; i++) {
                    spawnMarble(true); // true = spawn static/randomly
                }
            }
        }

        function saveProgress() {
            localStorage.setItem('victoryJarCount', marbles.length);
            updateStats();
        }

        function updateStats() {
            document.getElementById('dayCount').innerText = marbles.length;
            
            let percentage = Math.min(100, Math.floor((marbles.length / MARBLE_COUNT_GOAL) * 100));
            document.getElementById('percentFull').innerText = percentage + '%';

            // Update message
            const msgBox = document.getElementById('motivationText');
            let currentMsg = messages[0].text;
            
            // Find highest threshold met
            for (let m of messages) {
                if (marbles.length >= m.threshold) {
                    currentMsg = m.text;
                }
            }
            msgBox.innerText = currentMsg;
        }

        /**
         * Marble Logic
         */
        class Marble {
            constructor(x, y, isStatic = false) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 4; // Random horizontal velocity
                this.vy = isStatic ? 0 : -5; // Start slightly up or falling
                this.radius = MARBLE_RADIUS;
                this.color = '#FFD700';
                this.settled = false;
            }

            draw() {
                // Create 3D effect with Radial Gradient
                let grad = ctx.createRadialGradient(
                    this.x - 3, this.y - 3, this.radius * 0.2, 
                    this.x, this.y, this.radius
                );
                grad.addColorStop(0, '#FFFFE0'); // Highlight
                grad.addColorStop(0.3, '#FFD700'); // Gold
                grad.addColorStop(1, '#B8860B'); // Shadow

                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = grad;
                ctx.fill();
                ctx.closePath();
            }

            update() {
                if (this.settled) return; // Optimization: Don't calculate if settled

                // Gravity
                this.vy += GRAVITY;

                // Position update
                this.x += this.vx;
                this.y += this.vy;

                // Wall Collisions
                // Left Wall
                if (this.x - this.radius < JAR_X + 5) {
                    this.x = JAR_X + 5 + this.radius;
                    this.vx *= -BOUNCE_DAMPING;
                }
                // Right Wall
                if (this.x + this.radius > JAR_X + JAR_WIDTH - 5) {
                    this.x = JAR_X + JAR_WIDTH - 5 - this.radius;
                    this.vx *= -BOUNCE_DAMPING;
                }
                // Floor
                if (this.y + this.radius > JAR_Y + JAR_HEIGHT - 5) {
                    this.y = JAR_Y + JAR_HEIGHT - 5 - this.radius;
                    this.vy *= -BOUNCE_DAMPING;
                    this.vx *= FRICTION; // Ground friction

                    // Stop if slow enough
                    if (Math.abs(this.vy) < 0.5 && Math.abs(this.vx) < 0.1) {
                        this.vy = 0;
                        this.vx = 0;
                        // this.settled = true; // Uncomment for performance if needed, but keeps physics alive
                    }
                }
            }
        }

        function spawnMarble(randomPos = false) {
            let x, y;
            
            if (randomPos) {
                // Spawn randomly within the jar (for loading)
                x = JAR_X + MARBLE_RADIUS + Math.random() * (JAR_WIDTH - MARBLE_RADIUS * 2);
                // Estimate y based on count to prevent huge stacking drop
                // This is a rough approximation to fill the jar from bottom up on load
                let rows = Math.floor(marbles.length / 10); 
                let heightOffset = rows * (MARBLE_RADIUS * 1.8);
                y = (JAR_Y + JAR_HEIGHT - MARBLE_RADIUS - 10) - heightOffset - (Math.random() * 50);
            } else {
                // Spawn at top
                x = JAR_X + JAR_WIDTH / 2;
                y = JAR_Y - 30;
            }

            marbles.push(new Marble(x, y, randomPos));
        }

        function resolveCollisions() {
            for (let i = 0; i < marbles.length; i++) {
                for (let j = i + 1; j < marbles.length; j++) {
                    let m1 = marbles[i];
                    let m2 = marbles[j];

                    let dx = m2.x - m1.x;
                    let dy = m2.y - m1.y;
                    let distance = Math.sqrt(dx * dx + dy * dy);
                    let minDist = m1.radius + m2.radius;

                    if (distance < minDist) {
                        // Collision detected
                        let angle = Math.atan2(dy, dx);
                        let sin = Math.sin(angle);
                        let cos = Math.cos(angle);

                        // Rotate velocities
                        let vx1 = m1.vx * cos + m1.vy * sin;
                        let vy1 = m1.vy * cos - m1.vx * sin;
                        let vx2 = m2.vx * cos + m2.vy * sin;
                        let vy2 = m2.vy * cos - m2.vx * sin;

                        // Swap x velocities (perfect elastic collision assumption for simplicity)
                        // Usually mass is involved, but all marbles have same mass
                        let vx1Final = vx2;
                        let vx2Final = vx1;

                        // Update velocities
                        m1.vx = vx1Final * cos - vy1 * sin;
                        m1.vy = vy1 * cos + vx1Final * sin;
                        m2.vx = vx2Final * cos - vy2 * sin;
                        m2.vy = vy2 * cos + vx2Final * sin;

                        // Separate marbles to prevent sticking
                        let overlap = minDist - distance;
                        let separateX = overlap * cos * 0.5;
                        let separateY = overlap * sin * 0.5;
                        
                        m1.x -= separateX;
                        m1.y -= separateY;
                        m2.x += separateX;
                        m2.y += separateY;
                        
                        // Apply damping
                        m1.vx *= 0.95;
                        m1.vy *= 0.95;
                        m2.vx *= 0.95;
                        m2.vy *= 0.95;
                    }
                }
            }
        }

        /**
         * Drawing Functions
         */
        function drawJar() {
            // Draw Back of Jar (Fill)
            ctx.beginPath();
            // Rounded rectangle path
            ctx.moveTo(JAR_X, JAR_Y);
            ctx.lineTo(JAR_X, JAR_Y + JAR_HEIGHT - 40);
            ctx.quadraticCurveTo(JAR_X, JAR_Y + JAR_HEIGHT, JAR_X + 40, JAR_Y + JAR_HEIGHT);
            ctx.lineTo(JAR_X + JAR_WIDTH - 40, JAR_Y + JAR_HEIGHT);
            ctx.quadraticCurveTo(JAR_X + JAR_WIDTH, JAR_Y + JAR_HEIGHT, JAR_X + JAR_WIDTH, JAR_Y + JAR_HEIGHT - 40);
            ctx.lineTo(JAR_X + JAR_WIDTH, JAR_Y);
            
            // Glass Style
            ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.fill();
            ctx.lineWidth = 4;
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.stroke();
            ctx.closePath();

            // Jar Label (Optional)
            ctx.fillStyle = 'rgba(255, 215, 0, 0.6)';
            ctx.font = 'italic 16px serif';
            ctx.textAlign = 'center';
            ctx.fillText("Victories", JAR_X + JAR_WIDTH/2, JAR_Y + JAR_HEIGHT/2);
            
            // Rim of the jar (Top ellipse)
            ctx.beginPath();
            ctx.ellipse(JAR_X + JAR_WIDTH/2, JAR_Y, JAR_WIDTH/2, 10, 0, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.fill();
            ctx.stroke();
        }

        function drawForegroundGlass() {
            // Reflection on glass
            ctx.beginPath();
            ctx.moveTo(JAR_X + 20, JAR_Y + 20);
            ctx.lineTo(JAR_X + 20, JAR_Y + JAR_HEIGHT - 50);
            ctx.lineWidth = 8;
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.stroke();
        }

        function animate() {
            // Clear Canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw Jar Background
            drawJar();

            // Physics Steps
            // Run physics multiple times per frame for stability
            for(let k=0; k<2; k++) {
                marbles.forEach(m => m.update());
                resolveCollisions();
            }

            // Draw Marbles
            marbles.forEach(m => m.draw());

            // Draw Glass Shine (Foreground)
            drawForegroundGlass();

            requestAnimationFrame(animate);
        }

        /**
         * User Interactions
         */
        function addMarble() {
            spawnMarble();
            saveProgress();
            
            // Visual feedback on button
            const btn = document.getElementById('addBtn');
            btn.style.transform = "scale(0.95)";
            setTimeout(() => btn.style.transform = "scale(1)", 100);
        }

        function resetJar() {
            if(confirm("Are you sure you want to reset the jar? This cannot be undone.")) {
                marbles = [];
                localStorage.removeItem('victoryJarCount');
                updateStats();
            }
        }

        function downloadImage() {
            // Create a temporary canvas to composite background + jar
            // because the main canvas is transparent
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');

            // Fill Background
            tempCtx.fillStyle = '#1a1a1a'; // Match body bg
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

            // Draw Title
            tempCtx.fillStyle = '#FFD700';
            tempCtx.font = 'bold 24px Segoe UI';
            tempCtx.textAlign = 'center';
            tempCtx.fillText("My Victory Jar", tempCanvas.width/2, 50);

            // Draw current canvas state
            tempCtx.drawImage(canvas, 0, 0);

            // Draw footer
            tempCtx.fillStyle = '#888';
            tempCtx.font = '14px Segoe UI';
            tempCtx.fillText(`${marbles.length} Days Strong`, tempCanvas.width/2, tempCanvas.height - 20);

            // Export
            const link = document.createElement('a');
            link.download = `victory-jar-day-${marbles.length}.png`;
            link.href = tempCanvas.toDataURL();
            link.click();

            showToast();
        }

        function showToast() {
            const x = document.getElementById("toast");
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }
        
        // Canvas click to add marble (Accessibility feature)
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            // Only add if click is near the top
            if (e.clientY - rect.top < JAR_Y + 50) {
                addMarble();
            }
        });

    </script>
</body>
</html>
